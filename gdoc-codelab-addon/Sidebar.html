<!DOCTYPE html>
<html lang="en">

<head>
    <base target="_top">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Codelab Format Tools</title>

    <style>
        * {
            box-sizing: border-box;
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
        }

        body {
            margin: 0;
            background: #f8f9fa;
            font-size: 13px;
            color: #202124;
        }

        .sidebar {
            width: 100%;
            min-height: 100vh;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 16px;
            border-bottom: 1px solid #dadce0;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            margin: 0 0 8px 0;
            color: #202124;
        }

        .header .context {
            font-size: 12px;
            color: #5f6368;
            padding: 6px 10px;
            background: #f1f3f4;
            border-radius: 12px;
            display: inline-block;
        }

        .header .help-icon {
            float: right;
            cursor: pointer;
            color: #5f6368;
            font-size: 18px;
            margin-top: -2px;
        }

        /* Search */
        .search {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            background: #fff;
        }

        .search input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #dadce0;
            outline: none;
            transition: border-color 0.2s;
        }

        .search input:focus {
            border-color: #1a73e8;
        }

        /* Main content */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Quick actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .quick-actions button {
            padding: 10px 8px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid #dadce0;
            background: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #202124;
        }

        .quick-actions button:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
        }

        .quick-actions button:active {
            background: #e8eaed;
        }

        /* Sections */
        .section {
            margin-bottom: 16px;
        }

        .section summary {
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 0;
            color: #202124;
            list-style: none;
            user-select: none;
        }

        .section summary::-webkit-details-marker {
            display: none;
        }

        .section summary::before {
            content: '‚ñ∂';
            display: inline-block;
            width: 16px;
            margin-right: 8px;
            transition: transform 0.2s;
            color: #5f6368;
            font-size: 10px;
        }

        .section[open] summary::before {
            transform: rotate(90deg);
        }

        .section-content {
            padding-left: 4px;
            margin-top: 8px;
        }

        .format-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .format-item:hover {
            background: #f8f9fa;
            border-color: #1a73e8;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .format-item:active {
            background: #e8eaed;
        }

        .format-title {
            font-size: 13px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 4px;
        }

        .format-preview {
            font-size: 11px;
            color: #5f6368;
            line-height: 1.4;
        }

        .format-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 6px;
        }

        .badge-table {
            background: #e8f0fe;
            color: #1967d2;
        }

        .badge-inline {
            background: #fce8e6;
            color: #c5221f;
        }

        .badge-heading {
            background: #e6f4ea;
            color: #137333;
        }

        /* Context panel */
        .context-panel {
            border-top: 1px dashed #dadce0;
            margin-top: 20px;
            padding-top: 16px;
        }

        .context-panel h3 {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #202124;
        }

        .context-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 10px;
        }

        .context-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .context-actions button {
            flex: 1;
            min-width: 80px;
            padding: 8px 10px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #dadce0;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .context-actions button:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
        }

        /* Footer */
        .footer {
            border-top: 1px solid #e0e0e0;
            padding: 12px 16px;
            background: #fff;
            position: sticky;
            bottom: 0;
        }

        .footer button {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            border: none;
            background: #1a73e8;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }

        .footer button:hover {
            background: #1557b0;
        }

        .footer button:active {
            background: #0d47a1;
        }

        .status {
            font-size: 11px;
            color: #137333;
            margin-top: 8px;
            text-align: center;
            font-weight: 500;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 20px;
            color: #5f6368;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1a73e8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #5f6368;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        /* Utility */
        .hidden {
            display: none;
        }

        /* Scrollbar */
        .content::-webkit-scrollbar {
            width: 8px;
        }

        .content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>

<body>
    <div class="sidebar">

        <!-- Header -->
        <div class="header">
            <span class="help-icon" onclick="showHelp()" title="Show format guide">‚ìò</span>
            <h1>Codelab Format Tools</h1>
            <div class="context" id="contextBadge">Ready</div>
        </div>

        <!-- Search -->
        <div class="search">
            <input type="text" id="searchInput" placeholder="Search formats..." oninput="filterFormats()" />
        </div>

        <!-- Content -->
        <div class="content">

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button onclick="runAction('insertStepHeading')" title="Add new step (H1)">
                    üìù Step
                </button>
                <button onclick="runAction('insertSectionH2')" title="Add section (H2)">
                    üìÑ Section
                </button>
                <button onclick="runAction('createPositiveInfobox')" title="Tip/best practice">
                    ‚úÖ Tip
                </button>
                <button onclick="runAction('createNegativeInfobox')" title="Warning/caution">
                    ‚ö†Ô∏è Warning
                </button>
                <button onclick="runAction('createCodeBlock')" title="Code snippet">
                    üíª Code
                </button>
                <button onclick="runAction('applyInlineCode')" title="Inline code">
                    `‚åò` Inline
                </button>
            </div>

            <!-- Sections -->
            <details class="section" open data-category="structure">
                <summary>Headings & Structure</summary>
                <div class="section-content">

                    <div class="format-item" onclick="runAction('insertStepHeading')">
                        <div class="format-title">
                            Step Title (H1)
                            <span class="format-badge badge-heading">Required</span>
                        </div>
                        <div class="format-preview">Creates a new step in table of contents</div>
                    </div>

                    <div class="format-item" onclick="runAction('insertSectionH2')">
                        <div class="format-title">Section Heading (H2)</div>
                        <div class="format-preview">Main section within a step</div>
                    </div>

                    <div class="format-item" onclick="runAction('insertSectionH3')">
                        <div class="format-title">Subsection (H3)</div>
                        <div class="format-preview">Subsection or code filename</div>
                    </div>

                    <div class="format-item" onclick="runAction('insertMetadataTable')">
                        <div class="format-title">
                            Metadata Table
                            <span class="format-badge badge-table">Table</span>
                        </div>
                        <div class="format-preview">Summary, URL, Category, etc.</div>
                    </div>

                </div>
            </details>

            <details class="section" open data-category="blocks">
                <summary>Blocks & Callouts</summary>
                <div class="section-content">

                    <div class="format-item" onclick="runAction('createPositiveInfobox')">
                        <div class="format-title">
                            Positive Infobox
                            <span class="format-badge badge-table">Green</span>
                        </div>
                        <div class="format-preview">Tips, best practices, time savers</div>
                    </div>

                    <div class="format-item" onclick="runAction('createNegativeInfobox')">
                        <div class="format-title">
                            Negative Infobox
                            <span class="format-badge badge-table">Orange</span>
                        </div>
                        <div class="format-preview">Warnings, restrictions, gotchas</div>
                    </div>

                    <div class="format-item" onclick="runAction('createCodeBlock')">
                        <div class="format-title">
                            Code Block
                            <span class="format-badge badge-table">Courier</span>
                        </div>
                        <div class="format-preview">Code snippet with syntax highlighting</div>
                    </div>

                    <div class="format-item" onclick="runAction('createConsoleBlock')">
                        <div class="format-title">
                            Console Block
                            <span class="format-badge badge-table">Consolas</span>
                        </div>
                        <div class="format-preview">Terminal commands and output</div>
                    </div>

                    <div class="format-item" onclick="runAction('createSurveyBlock')">
                        <div class="format-title">
                            Survey Question
                            <span class="format-badge badge-table">Blue</span>
                        </div>
                        <div class="format-preview">Multiple choice question</div>
                    </div>

                </div>
            </details>

            <details class="section" data-category="inline">
                <summary>Inline Formatting</summary>
                <div class="section-content">

                    <div class="format-item" onclick="runAction('applyInlineCode')">
                        <div class="format-title">
                            Inline Code
                            <span class="format-badge badge-inline">Selection</span>
                        </div>
                        <div class="format-preview">Variable names, commands</div>
                    </div>

                    <div class="format-item" onclick="runAction('createDownloadButton')">
                        <div class="format-title">
                            Download Button
                            <span class="format-badge badge-inline">Link</span>
                        </div>
                        <div class="format-preview">Green button for downloads</div>
                    </div>

                    <div class="format-item" onclick="insertMeta('Duration')">
                        <div class="format-title">Duration Annotation</div>
                        <div class="format-preview">Duration: 5:00 (grey text)</div>
                    </div>

                    <div class="format-item" onclick="insertMeta('Environment')">
                        <div class="format-title">Environment Tag</div>
                        <div class="format-preview">Environment: Web (grey text)</div>
                    </div>

                </div>
            </details>

            <details class="section" data-category="special">
                <summary>Special Features</summary>
                <div class="section-content">

                    <div class="format-item" onclick="showYouTubeHelp()">
                        <div class="format-title">YouTube Video Embed</div>
                        <div class="format-preview">Image + alt text with YouTube URL</div>
                    </div>

                    <div class="format-item" onclick="showIframeHelp()">
                        <div class="format-title">Iframe Embed</div>
                        <div class="format-preview">Image + alt text with URL</div>
                    </div>

                    <div class="format-item" onclick="insertSpecialHeading('FAQ')">
                        <div class="format-title">FAQ Section</div>
                        <div class="format-preview">H3: "Frequently Asked Questions"</div>
                    </div>

                    <div class="format-item" onclick="insertSpecialHeading('Learn')">
                        <div class="format-title">What You'll Learn</div>
                        <div class="format-preview">H2 with checklist</div>
                    </div>

                </div>
            </details>

            <!-- Context Panel -->
            <div class="context-panel">
                <h3>Current Context</h3>
                <div class="context-info" id="contextInfo">
                    No selection
                </div>
                <div class="context-actions">
                    <button onclick="refreshContext()">üîÑ Refresh</button>
                    <button onclick="runAction('validateDocument')">‚úì Validate</button>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="footer">
            <button onclick="runAction('validateDocument')">
                Validate Document
            </button>
            <div class="status" id="statusText">Ready to format</div>
        </div>

    </div>

    <script>
        // Initialize on load
        window.onload = function () {
            refreshContext();
        };

        // Run server-side action
        function runAction(actionName) {
            showLoading();
            google.script.run
                .withSuccessHandler(onActionComplete)
                .withFailureHandler(onActionError)
            [actionName]();
        }

        // Refresh context
        function refreshContext() {
            google.script.run
                .withSuccessHandler(updateContext)
                .withFailureHandler(onActionError)
                .getDocumentContext();
        }

        // Update context display
        function updateContext(context) {
            const badge = document.getElementById('contextBadge');
            const info = document.getElementById('contextInfo');

            if (context.hasSelection) {
                badge.textContent = 'Selection: ' + context.selectionType.replace('_', ' ');
                badge.style.background = '#e8f0fe';
                badge.style.color = '#1967d2';

                let infoText = 'Selected: ' + context.selectionType;
                if (context.currentFormat.type) {
                    infoText += '<br>Format: ' + context.currentFormat.type;
                }
                info.innerHTML = infoText;
            } else {
                badge.textContent = 'Cursor: ' + context.cursorPosition.replace('_', ' ');
                badge.style.background = '#f1f3f4';
                badge.style.color = '#5f6368';

                info.textContent = 'Ready to insert or format';
            }
        }

        // Filter formats by search
        function filterFormats() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const items = document.querySelectorAll('.format-item');
            const sections = document.querySelectorAll('.section');

            if (query === '') {
                items.forEach(item => item.style.display = 'block');
                return;
            }

            items.forEach(item => {
                const title = item.querySelector('.format-title').textContent.toLowerCase();
                const preview = item.querySelector('.format-preview').textContent.toLowerCase();

                if (title.includes(query) || preview.includes(query)) {
                    item.style.display = 'block';
                    // Open parent section
                    let section = item.closest('.section');
                    if (section) section.setAttribute('open', '');
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Insert meta annotation
        function insertMeta(type) {
            let text = type + ': ';
            if (type === 'Duration') {
                text += '5:00';
            } else if (type === 'Environment') {
                text += 'Web';
            }

            showLoading();
            google.script.run
                .withSuccessHandler(onActionComplete)
                .withFailureHandler(onActionError)
                .applyMetaAnnotation(text);
        }

        // Insert special heading
        function insertSpecialHeading(type) {
            let text = '';
            let level = 2;

            if (type === 'FAQ') {
                text = 'Frequently Asked Questions';
                level = 3;
            } else if (type === 'Learn') {
                text = "What you'll learn";
                level = 2;
            }

            showLoading();
            google.script.run
                .withSuccessHandler(onActionComplete)
                .withFailureHandler(onActionError)
                .insertSectionHeading(level);
        }

        // Show YouTube help
        function showYouTubeHelp() {
            alert('YouTube Embed:\n\n1. Insert an image\n2. Right-click > Alt text\n3. In Description field, paste YouTube URL:\n   https://www.youtube.com/watch?v=VIDEO_ID\n\nThe image will be replaced with embedded video.');
        }

        // Show iframe help
        function showIframeHelp() {
            alert('Iframe Embed:\n\n1. Insert an image\n2. Right-click > Alt text\n3. In Description field, paste URL\n\nNote: Only allowlisted domains work. See format guide for list.');
        }

        // Show format guide
        function showHelp() {
            google.script.run.showFormatGuide();
        }

        // Success handler
        function onActionComplete(result) {
            hideLoading();
            setStatus('‚úì Applied', 'success');
            setTimeout(() => {
                setStatus('Ready to format', 'ready');
                refreshContext();
            }, 2000);
        }

        // Error handler
        function onActionError(error) {
            hideLoading();
            setStatus('Error: ' + error, 'error');
            setTimeout(() => setStatus('Ready to format', 'ready'), 3000);
        }

        // Loading state
        function showLoading() {
            setStatus('Processing...', 'loading');
        }

        function hideLoading() {
            // Handled by success/error
        }

        // Update status
        function setStatus(text, type) {
            const status = document.getElementById('statusText');
            status.textContent = text;

            if (type === 'success') {
                status.style.color = '#137333';
            } else if (type === 'error') {
                status.style.color = '#c5221f';
            } else if (type === 'loading') {
                status.style.color = '#1967d2';
            } else {
                status.style.color = '#5f6368';
            }
        }
    </script>
</body>

</html>